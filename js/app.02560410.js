(function(t){function e(e){for(var i,r,a=e[0],l=e[1],c=e[2],u=0,f=[];u<a.length;u++)r=a[u],Object.prototype.hasOwnProperty.call(s,r)&&s[r]&&f.push(s[r][0]),s[r]=0;for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(t[i]=l[i]);h&&h(e);while(f.length)f.shift()();return o.push.apply(o,c||[]),n()}function n(){for(var t,e=0;e<o.length;e++){for(var n=o[e],i=!0,a=1;a<n.length;a++){var l=n[a];0!==s[l]&&(i=!1)}i&&(o.splice(e--,1),t=r(r.s=n[0]))}return t}var i={},s={app:0},o=[];function r(e){if(i[e])return i[e].exports;var n=i[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=i,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/midi-test/";var a=window["webpackJsonp"]=window["webpackJsonp"]||[],l=a.push.bind(a);a.push=e,a=a.slice();for(var c=0;c<a.length;c++)e(a[c]);var h=l;o.push([0,"chunk-vendors"]),n()})({0:function(t,e,n){t.exports=n("56d7")},"034f":function(t,e,n){"use strict";n("85ec")},3856:function(t,e,n){},"519a":function(t,e,n){},"534a":function(t,e,n){"use strict";n("fe51")},"56d7":function(t,e,n){"use strict";n.r(e);n("e260"),n("e6cf"),n("cca6"),n("a79d");var i=n("2b0e"),s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{attrs:{id:"app"}},[n("MidiDemo")],1)},o=[],r=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"page"},[n("h1",[t._v("Here is a midi display demo by Molar~")]),n("div",{staticClass:"ScrollArea"},[n("div",{staticClass:"container"},[n("div",{staticClass:"piano"},[n("piano")],1),n("div",{staticClass:"roll"},[t.update?n("roll",{attrs:{track:t.showTrack,playing:t.playing,xAxis:t.value2/100+.5}}):t._e()],1)])]),n("el-row",[n("el-switch",{staticStyle:{margin:"10px 10px"},attrs:{"active-text":"YouveGotAFriend","inactive-text":"IFeelTheEarthMove"},on:{change:t.changeMidi},model:{value:t.value1,callback:function(e){t.value1=e},expression:"value1"}}),n("el-button",{staticStyle:{margin:"10px 10px"},on:{click:t.handleChange}},[t._v("Playing:"+t._s(t.playing))]),n("el-select",{staticStyle:{margin:"10px 10px"},attrs:{placeholder:"当前未选择"},on:{change:function(e){return t.onChange()}},model:{value:t.value,callback:function(e){t.value=e},expression:"value"}},t._l(t.tracks,(function(t){return n("el-option",{key:"track"+t.index,attrs:{label:"Track:"+t.index+" Instrument:"+t.instrument.name,value:t.index}})})),1)],1),n("el-slider",{attrs:{step:10,"format-tooltip":t.formatTooltip,"show-stops":""},model:{value:t.value2,callback:function(e){t.value2=e},expression:"value2"}})],1)},a=[],l=(n("4160"),n("159b"),n("b85c")),c=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"keyboard",style:t.style},[n("ul",t._l(t.keys,(function(e,i){return n("li",{key:i,class:[].concat(e.class),style:e.style},[-1!=e.name.indexOf("C")&&-1===e.name.indexOf("#")?n("span",[t._v(t._s(e.name))]):t._e()])})),0)])},h=[],u=(n("99af"),["C","D","E","F","G","A","B"]),f=["C#","D#",null,"F#","G#","A#",null],d=7,v=5,p=-1,m=9,y=0,g=6,_=function(t,e,n){return Math.max(e,Math.min(n,t))},x={data:function(){return{offsets:{octaveStart:-1,octaveEnd:9,noteStart:0,noteEnd:4}}},methods:{calculateOctave:function(t){return Math.floor(t/d)+Math.max(p,this.offsets.octaveStart)}},computed:{offsetStart:function(){return _(this.offsets.noteStart,y,g)},offsetEnd:function(){return _(this.offsets.noteEnd,y,g)},totalWhiteKeys:function(){return this.numOctaves*d-this.offsets.noteStart-(d-(this.offsets.noteEnd+1))},totalBlackKeys:function(){return this.numOctaves*v-this.offsets.noteStart-(v-(this.offsets.noteEnd+1))},totalKeys:function(){return this.totalWhiteKeys+this.totalBlackKeys},numOctaves:function(){return Math.min(m,this.offsets.octaveEnd)-Math.max(p,this.offsets.octaveStart)+1},style:function(){return{"--keys":this.totalWhiteKeys,"--octaves":this.numOctaves}},keys:function(){for(var t=[],e=1,n=this.offsetStart,i=0;i<this.totalWhiteKeys;n++,i++){var s=this.calculateOctave(n),o=u[n%7],r=3;n%7!==1&&n%7!==4&&n%7!==5||(r=4);var a={name:"".concat(o).concat(s),class:["white"],style:{"grid-row":"".concat(e," / span ").concat(r)}};e+=r,t.push(a)}e=0;for(var l=this.offsetStart,c=0;c<this.totalWhiteKeys;l++,c++){var h=3;l%7!==1&&l%7!==4&&l%7!==5||(h=4),e+=h;var d=this.calculateOctave(l),v=f[l%7];if(v&&(!(d>=10)&&(9!==d||l%7!==4))){var p={name:"".concat(v).concat(d),class:["black"],style:{"grid-row":"".concat(e," / span 2")}};t.push(p)}}return t}}},S=x,k=(n("9747"),n("2877")),w=Object(k["a"])(S,c,h,!1,null,"746bffe9",null),b=w.exports,O=function(){var t=this,e=t.$createElement;t._self._c;return t._m(0)},C=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{attrs:{id:"root"}},[n("div",{attrs:{id:"RollContainer"}},[n("div",{attrs:{id:"ScrollContainer"}},[n("div",{attrs:{id:"PianoRoll"}})]),n("canvas",{attrs:{id:"ScoreCanvas"}})])])}],P=(n("a9e3"),n("d4ec")),M=n("bee2"),E=n("4393"),N=n.n(E),j=(n("b0c0"),n("5e54")),T=function(){function t(e,n){Object(P["a"])(this,t),this.noteOn=j["a"].toSeconds(e.time),this.duration=j["a"].toSeconds(e.duration),this.noteOff=this.noteOn+this.duration,this.strokeColor="#A2F0B1",this.fillColor="#217230",this.note=e.name,this.velocity=e.velocity,this.midiNote=e.midi;var i=this.midiNote;i*=n.noteHeight,this.top=i,this.left=this.noteOn*n.pixelsPerSecond,this.width=this.duration*n.pixelsPerSecond,this.height=n.noteHeight}return Object(M["a"])(t,[{key:"draw",value:function(t){t.beginPath(),t.fillStyle=this.fillColor,t.strokeStyle=this.strokeColor,t.fillRect(2*this.left,2*this.top,2*this.width,2*this.height);var e=Math.min(Math.min(this.width,6),Math.min(this.height,6)),n=2*this.height-2*e;n>=this.width?t.lineWidth=this.width:t.lineWidth=n,t.beginPath(),t.moveTo(2*this.left+e+n/2,2*this.top+e+n/2),t.lineTo(2*this.left+2*this.width-e-n/2,2*this.top+e+n/2),t.closePath(),t.lineJoin="round",t.stroke()}},{key:"dispose",value:function(){this.element.remove(),this.element=null}}]),t}(),A=function(){function t(e,n){Object(P["a"])(this,t),this.notes=[],this.element=e,this.currentlyDisplayedNotes=[],this.intervalTree=null,this.width=0,this.actualH=n,this.canvas=document.getElementById("ScoreCanvas"),this.canvasWidth=0,this.canvasHeight=0,this.context=this.canvas.getContext("2d"),window.addEventListener("resize",this.resize.bind(this)),this.resize(),this._currentNotes=null}return Object(M["a"])(t,[{key:"setNotes",value:function(t){this._currentNotes=t,this.clearNotes();var e=(this.actualH-25)/128,n={min:0,max:127,pixelsPerSecond:this.pixelsPerSecond,noteHeight:e};this.intervalTree=new N.a;for(var i=-1/0,s=0;s<t.length;s++){var o=new T(t[s],n);o.noteOff>i&&(i=o.noteOff),this.intervalTree.insert([o.noteOn,o.noteOff,o])}console.log(i*this.pixelsPerSecond),console.log(this.element),this.width=i*this.pixelsPerSecond,this.element.style.width=this.width+"px"}},{key:"resize",value:function(){this.canvasWidth=2*this.canvas.offsetWidth,this.canvasHeight=2*this.canvas.offsetHeight,this.context.canvas.width=this.canvasWidth,this.context.canvas.height=this.canvasHeight,this._currentNotes&&this.setNotes(this._currentNotes)}},{key:"getDuration",value:function(){for(var t=0,e=0;e<this.notes.length;e++)this.notes[e].noteOff>t&&(t=this.notes[e].noteOff);return t}},{key:"showOnScreenNotes",value:function(t,e){var n=t/this.pixelsPerSecond,i=e/this.pixelsPerSecond;if(null!==this.intervalTree){var s=[];this.intervalTree.queryInterval(n,i,(function(t){s.push(t[2])})),this.currentlyDisplayedNotes=s}}},{key:"clearNotes",value:function(){for(var t=0;t<this.notes.length;t++){var e=this.notes[t];e.dispose()}this.notes=[]}},{key:"dispose",value:function(){this.clearNotes(),this.element.remove(),this.element=null}},{key:"draw",value:function(t){this.context.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.context.save(),this.drawBg(),this.context.translate(2*-t,0);for(var e=this.currentlyDisplayedNotes,n=0;n<e.length;n++){var i=e[n];i.draw(this.context)}this.context.restore()}},{key:"drawBg",value:function(){for(var t=["#282828","#363636"],e=(this.actualH-25)/128*2,n=0;n<128;n++)this.context.strokeStyle=t[n%2],this.context.fillStyle=t[n%2],this.context.fillRect(0,n*e,this.canvasWidth,e)}}]),t}();A.prototype.pixelsPerSecond=200;var W=function(){function t(e,n){Object(P["a"])(this,t),this.element=e,this.currentScroll=-1,this.pixelsPerSecond=n,this.lastUpdate=-1,this.autoAdvance=!1,this.scrollDifference=0,this.restStart=-1,this._boundloop=this.loop.bind(this),this.loop()}return Object(M["a"])(t,[{key:"loop",value:function(){var t=Date.now();if(requestAnimationFrame(this._boundloop),-1!==this.lastUpdate&&this.autoAdvance){var e=t-this.lastUpdate;this.currentScroll+=e/1e3*this.pixelsPerSecond,this.element.scrollLeft=Math.round(this.currentScroll)}this.lastUpdate=t}},{key:"start",value:function(){this.currentScroll=this.element.scrollLeft,this.autoAdvance=!0}},{key:"stop",value:function(){this.autoAdvance=!1}},{key:"restart",value:function(){this.element.scrollLeft=0,this.currentScroll=0}},{key:"changePixelsPerSecond",value:function(t){this.pixelsPerSecond=t}}]),t}(),H=function(){function t(){Object(P["a"])(this,t),this._element=document.getElementById("RollContainer"),this._scrollContainer=document.getElementById("ScrollContainer"),this._scrollElement=document.getElementById("PianoRoll"),this._score=new A(this._scrollElement,this._scrollContainer.offsetHeight),this._scroll=new W(this._scrollContainer,this._score.pixelsPerSecond),this._started=!1,this._currentNotes=[],this._currentScroll=-1,this._bindedLoop=this._loop.bind(this),this._loop(),this._width=this._scrollContainer.offsetWidth,window.addEventListener("resize",this._resize.bind(this))}return Object(M["a"])(t,[{key:"_resize",value:function(){this._width=this._scrollContainer.offsetWidth}},{key:"_onScreenNotes",value:function(){var t=this._width;this._score.showOnScreenNotes(this._currentScroll,this._currentScroll+t)}},{key:"_loop",value:function(){requestAnimationFrame(this._bindedLoop);var t=this._scrollContainer.scrollLeft;t!==this._currentScroll&&(this._currentScroll=t,this._onScreenNotes(),this._score.draw(this._currentScroll))}},{key:"setScore",value:function(t){this._score.setNotes(t.notes),this._currentScroll=0,this._scrollContainer.scrollLeft=this._currentScroll,this._onScreenNotes()}},{key:"start",value:function(){this._scroll.start()}},{key:"stop",value:function(){this._scroll.stop()}},{key:"update",value:function(t){this._score.setNotes(t.notes),this._onScreenNotes(),this._score.draw(this._currentScroll)}},{key:"changeXAxis",value:function(t,e){this._score.pixelsPerSecond=200*t,this._currentScroll*=t/e,this._scrollContainer.scrollLeft*=t/e,this._scroll.changePixelsPerSecond(200*t,this._width)}}]),t}(),B={props:{track:Object,playing:Boolean,xAxis:Number},data:function(){return{notes:[],roll:null}},watch:{xAxis:function(t,e){this.roll.changeXAxis(t,e),this.roll.update(this.track),this.playing&&this.roll.start()},track:function(t){console.log("new track"),console.log(t),console.log("update"),this.roll.update(t)},playing:function(t){t?(console.log("wow"),this.roll.start()):(console.log("wuwu"),this.roll.stop())}},computed:{},methods:{},created:function(){},mounted:function(){null!==this.roll?(console.log("update"),this.roll.update(this.track)):(console.log("new"),this.roll=new H,this.roll.setScore(this.track)),this.playing&&this.roll.start()},updated:function(){}},D=B,L=(n("534a"),Object(k["a"])(D,O,C,!1,null,null,null)),F=L.exports,I=n("ef75"),K={name:"MidiDemo",data:function(){return{value:"",value2:50,playing:!1,tracks:[],showTrack:{},update:!1,value1:!0,MidiHead:{}}},components:{piano:b,roll:F},methods:{formatTooltip:function(t){return t/100+.5},handleChange:function(){this.playing=!this.playing},onChange:function(){console.log(this.value);var t,e=Object(l["a"])(this.tracks);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.index===this.value&&(this.showTrack=n)}}catch(i){e.e(i)}finally{e.f()}console.log(this.showTrack)},changeMidi:function(){this.tracks=[],this.getMidi()},getMidi:function(){var t=this;console.log("!!!!!"),console.log("/midi-test/"),I["Midi"].fromUrl(this.value1?"".concat("/midi-test/","audio/IFeelTheEarthMove.mid"):"".concat("/midi-test/","audio/YouveGotAFriend.mid")).then((function(e){console.log(e),e.tracks.forEach((function(e,n){if(0!==e.notes.length){var i=e;i.index=n,t.tracks.push(i)}})),0!==t.tracks.length&&(t.value=t.tracks[0].index,t.showTrack=t.tracks[0]),console.log(t.tracks),console.log(t.showTrack),t.update=!0}))}},created:function(){this.getMidi()}},z=K,R=(n("aba2"),Object(k["a"])(z,r,a,!1,null,"b5651b66",null)),$=R.exports,U={name:"App",components:{MidiDemo:$}},G=U,q=(n("034f"),Object(k["a"])(G,s,o,!1,null,null,null)),J=q.exports,X=n("5c96"),Y=n.n(X),Q=(n("0fae"),n("2f62"));i["default"].use(Q["a"]);var V=new Q["a"].Store({state:{},mutations:{},actions:{}});i["default"].config.productionTip=!1,i["default"].use(Y.a),new i["default"]({store:V,render:function(t){return t(J)}}).$mount("#app")},"85ec":function(t,e,n){},9747:function(t,e,n){"use strict";n("519a")},aba2:function(t,e,n){"use strict";n("3856")},fe51:function(t,e,n){}});
//# sourceMappingURL=app.02560410.js.map